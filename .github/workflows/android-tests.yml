# Run Todo app tests on an Android emulator.
# Reads platform and device from ci/config.yaml; supports "any_active" device.

name: Android Todo App Tests

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform'
        required: true
        default: 'android'
        type: choice
        options:
          - android
          - ios
      device:
        description: 'Device (any_active or specific id)'
        required: false
        default: 'any_active'
        type: string

jobs:
  test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read CI config
        id: config
        run: |
          # Use workflow_dispatch inputs if provided, otherwise fall back to ci/config.yaml
          if [ -n "${{ github.event.inputs.platform }}" ]; then
            echo "platform=${{ github.event.inputs.platform }}" >> $GITHUB_OUTPUT
          else
            platform=$(grep -E '^platform:' ci/config.yaml 2>/dev/null | sed 's/platform: *//' | tr -d ' "' || echo 'android')
            echo "platform=${platform}" >> $GITHUB_OUTPUT
          fi
          if [ -n "${{ github.event.inputs.device }}" ]; then
            echo "device=${{ github.event.inputs.device }}" >> $GITHUB_OUTPUT
          else
            device=$(grep -E '^device:' ci/config.yaml 2>/dev/null | sed 's/device: *//' | tr -d ' "' || echo 'any_active')
            echo "device=${device}" >> $GITHUB_OUTPUT
          fi
        working-directory: ${{ github.workspace }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Set up Node (for Appium)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Appium and UIAutomator2 driver
        run: |
          npm install -g appium
          appium driver install uiautomator2

      - name: Run Android emulator and tests
        if: steps.config.outputs.platform == 'android'
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          target: default
          arch: x86_64
          profile: pixel_9
          script: |
            set -e
            cd $GITHUB_WORKSPACE
            export remote_url="http://127.0.0.1:4723"
            if [ "${{ steps.config.outputs.device }}" = "any_active" ]; then
              export android_deviceName=$(adb devices | grep -E 'emulator-[0-9]+' | head -1 | awk '{print $1}')
            else
              export android_deviceName="${{ steps.config.outputs.device }}"
            fi
            echo "Using device (android_deviceName): $android_deviceName"
            if [ -f ci/todo.apk ]; then
              adb -s $android_deviceName install -r ci/todo.apk
              export android_app="$(pwd)/ci/todo.apk"
            fi
            appium &
            sleep 15
            python -m pytest tests/android_app/test_todo_app.py --platform android --device "${{ steps.config.outputs.device }}" -v --tb=short
        env:
          PLATFORM: ${{ steps.config.outputs.platform }}
          DEVICE: ${{ steps.config.outputs.device }}

      - name: Skip iOS on GitHub-hosted runner
        if: steps.config.outputs.platform == 'ios'
        run: echo "iOS tests require a macOS runner or a cloud device farm; skipping."
